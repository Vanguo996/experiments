# Systems Programming: Designing and Devloping Distributed Applications



## Introduction

分布式系统设计关键目标是：**透明性**。

其通常理解为隐藏底层架构，按功能划分组件、组件之间的通信。

第五章：Architechture view



第六章：

讲述分布式系统本身，包括其关键特性和功能需求，以及其设计开发相关的特殊挑战，讨论分布性带来的问题，解决这些问题的技术。

透明性是分布式应用程序中追求质量的关键，透明性也是贯穿所有章节的主题。



1.3.4  metrics for measuring the quality of distributed systems and application

- Functional behavior
- nonfunctional behavior  which are related to the overall quality of application in terms of aspects

scalability, availability,  robustness,  responsiveness, transparency

transparency is most important  - 隐藏组件的多样性和分布性细节，为用户呈现单个系统的假象。

transparency provision at system level also reduces the burden on application developer so that they can foucus their efforts on the business logic of the application. 



1.3.5 透明性简介

- 访问透明性：不论是本地还是远程对象，访问的接口必须一致。要以相同的操作访问对象。
- 位置透明性：通过对象名字或ID提交请求，就可以访问。无需知道对象所处的位置
- 复制透明性：在任何副本上实施的操作，必须在全部副本上产生相同的结果
- 并发透明性：确保共享数据的一致性
- 故障透明性：要求错误被隐藏，使得应用程序能够继续执行功能
- Scaling transparency:  
- 

分布式系统的通用需求，访问和位置透明性。

如果应用程序的全部部件都用相同语言开发，并运行在相同类型的平台上，那么实现透明性就无关紧要。





### 体系结构   Architecture

系统的组织方式、各组件之间的连接以及组件之间的关系。

对于一个分布式系统来说，体系结构的选择将影响它的

- **规模扩展性**

- 健壮性

- 系统资源使用效率也潜在影响系统有效性的所有方面。



#### 常见的结构和模式

静态结构：设计时就决定了组件之间的连接关系；动态结构：动态组件发现和连接的机制，自动配置服务和为服务器实例分配角色。



#### 异构性  

系统异构性的影响，克服异构性：中间件(grpc) 和 硬件虚拟化(visa) 和 容器化 等技术



在一个扩展需求中：**使用副本作为一种体系结构设计技术**来满足一些非功能性的需求 - 健壮性、可用性和响应能力。



体系结构对性能特征的影响：

- 规模可扩展性：增加组件数量、

- 灵活性：组件之间的耦合性，动态配置或者重新配置的可能程度
- 效率：组件之间的通信强度，



#### 物理和逻辑体系

分布式应用程序和系统开发人员，主要关心**逻辑体系结构**，组件之间的逻辑连接很重要，即使所有进程驻留在同一物理计算机工作，应用程序的逻辑也被认为是分布式的，



#### 关注点分离

在考虑某个应用程序的业务逻辑层的时候会有很多不同的关注点，这些关注点包括功能特性 - 比如获取实时数据，以及非功能性的需求：健壮性和可扩展性。



定义应用程序体系结构的关键点是关注点分离：系统会采用**代理服务**的方式用于解耦组件，

好处：这提升了运行时配置方面的灵活性，以及全生命周期内维护和升级方面的敏捷性。



# 分布式系统应用设计   Designing Distributed Systems    



> 本书介绍的模式都是基于k8s配置的，为什么需要k8s？这是需要说清楚的地方:
>
> The development of containers and container orchestrators has fundamentally changed distributed system development.

容器和容器编排技术的快速发展极大改变了分布式系统的开发和部署方式。从此有了全新的方式与接口来描述核心分布式系统的开发模式及可重用容器化的组件。

容器化构建模块是开发可重用组件和模式的基础，这些组件和模式大大简化并使得构建可靠分布式系统的过程。

because this containerized building blocks are the basis for development of reusable components and patterns that dramatically simplify and make accessible the practices of building reliable distributed systems.



- 深入理解设计模式和可重用组件如何帮助开发者开发可靠分布式系统。
- 借助边车，适配器和大使模式在单机环境中将功能分解成一组容器
- 多节点常见的松耦合模式，复制、扩展和组件之间的通信
- 大规模批处理设计模式，工作队列，基于事件的处理和协调工作流程



分布式系统的模式，模式的目的是提供一般建议或结构来指导设计。

#### 目录

边车模式：扩展和增强现有的应用容器

大使模式：改变和管理应用容器与外部世界的通信方式

适配器：修改应用容器接口，使其符合第三方应用所需的某些预定义接口格式





### 容器化的动机

- 资源隔离，建立资源边界。这便于在不同应用场景中为诸多服务建立优先级。
- 模块化重用
- 关注点分离，可以使得应用程序便于理解，轻松进行测试、更新和部署。提高敏捷性和灵活性。



k8s是一个用于容器化应用程序的自动化部署、扩展和管理的开源系统。



#### 容器进阶 - pod

如果有些容器之间有紧密的依赖关系，如共享网络命名空间和共享内存，这样可以把多个容器组合成pod





# Kubernetes up and running   

brendan burns



Kubernetes is open source orchestrator for deploying contaienrized application.

Deploying scalable, reliable systems in containers via application-oriented APIs

kubernetes is a proven infrastructure for distributed systems that is suitable for cloud-native developers of all scales.

# Managing Kubernetes 

brendan burns 





# 云原生基础架构  Cloud native infrastructure  



PaaS把操作系统对应用程序隐藏起来，工程师不需要花时间管理基础架构，



### 1.6 云原生基础架构

Cloud native infrastructure is infrastructrue that is hidden behind useful abstractions, controlled by APIs, managed by software, use these traits gives rise to a new pattern for managing the 

云原生基础架构是隐藏在抽象背后的的基础架构，利用由API控制，由软件管理这些新特性去高效地构建云原生应用。





Abstraction should allow the consumer to move up the stack and not reimplement the lower layers

抽象应该是如何让使用者“向上层堆栈移动”，而不是重新实现底层

![](https://tva1.sinaimg.cn/large/008eGmZEgy1gpnpq15y01j314o0s2dmd.jpg)



#### 由API 控制

云原生基础架构需要抽象底层的IaaS产品形成一层抽象层，新的层负责控制它下面的IaaS，以及显示自己的API让使用者控制

Cloud native infrastructure needs to abstract the underlying IaaS offerings to provide its own abstraction



#### 由软件控制

软件控制的基础架构能够具有扩展性、弹性以及可维护性。软件需要了解基础架构的抽象，如何抽象资源并相应实现可消费IaaS组件。



云原生基础架构 像PaaS产品



### 1.7 不是云原生基础架构

- 云原生不是在容器中运行应用程序。

- 打包应用程序的方式并不意味着拥有自治系统，

will not have the scalability and benefit of autonomous system

- 即使应用程序是CICD的，也不能从API驱动中受益

not mean you are benefiting from infrastructure that can complement API-driven deployment

- run a container orchestrator which provide many platform features in cloud native infrastructure 



### 1.8 云原生应用

云原生应用程序旨在提供弹性、敏捷性、可操作性和可观察性。

- Resiliency embraces failures instead of trying to prevent them,  dynamic nature on platform
- Agility allows for fast developments and quick iterations
- Operability adds control of application life cycles from inside the application instead of relying on external processes and monitors.   可操作性指从应用程序内部控制应用程序生命周期，而不依赖于外部进程和监视器
- Observabililty provides information to answer question about application state 有关应用程序状态问题



实现云原生应用程序所需特性的方法：

- 微服务
- 健康报告  health reporting
- 自动测量数据  Telemetry data 
- 弹性   resiliency
- 声明式  Declarative



##### 微服务

虽然微服务是实现应用程序灵活性的一种方法，但不是云原生应用程序的必需条件。



##### Declarative 



#### 1.9 云原生应用如何影响基础架构  - automation , operator, 

云原生应用不能直接在IaaS上运行或紧耦合到服务器的操作系统中受益，需要在自治环境中运行。

cloud-native application expect to be run in a dynamic environment with mostly autonomous systems

云原生基础架构是在提供自主应用程序管理的IaaS之上创建一个平台，该平台建立在动态创建的基础架构之上，抽象出各个服务器并促进动态资源分配调度。

cloud native  infrastructure creates a platfrom on top of IaaS that provides autonomous application management. the platform is built on top of dynamically created infrastructure to abstract away individual





Automation is not the same thing as autonomous, 

- Cloud native is about autonomous systems that do not require humans to make decision. 
- Automation allows humans to have bigger impact on the action they take



##### 总结

现在基础架构负责整体资源管理、动态协调、服务发现等，它需要提供一个服务不依赖于单个组件，而是依赖于API和自治系统平台，

cloud native application simplify their code complexity by decomposing into smaller services. 

These services provide monitoring, metrics and resiliency built directly into the applicaiton. New tooling is require to automate the management of service proli



### 第二章 何时采用云原生



2.3系统

云原生需要系统抽象，必需隐藏底层系统以提高可靠性。

云基础架构底层组件发生故障，并旨在优雅地处理此类故障。

kubernetes 是云原生基础架构？

kubernetes 是一个使得管理应用程序更加简单的框架 并以云原生的方式运行，

kubernetes is framework that makes  managing application easier and promotes doing so in a cloud-native way , and also in a uncloud-native way





# Cloud Native Using containers, Functions, and Data to Build Next-Generation Applications



cloud native applications are , at their core, distributed systems

1.4 summary

很多开发人员在构建云服务都困难，主要三个挑战是：

1. 分布式系统
2. 新技术，如容器以及函数计算
3. 构建云原生应用的方法，

Twelve-Factor manifesto, and compund SLAs



第二章

容器

实现隔离的方法是用命名空间和cgroups，命名空间可以允许操作系统的各个组件被切分为很多块，从而创建隔离的工作区，控制组又可以对资源的使用进行更加细粒度的控制，防止所有系统资源被一个容器霸占。



docker把复杂内核功能封装成对开发者友好的组件，容器化之后的软件单元，是指运行在容器中的服务能够完全地、私有地访问操作系统视图(操作系统视图是指它与其他容器实例访问的操作系统是相互隔离的)



# 左耳朵耗子专栏  - 分布式系统部分



21讲 分布式系统架构的冰与火

分布式系统架构的难点在于系统设计，以及管理和运维。



SOA基于服务的架构是构造分布式计算应用程序的方法。SOAP、WSDL、XML这样的标准已经被抛弃，改成RESTful和JSON。ESB被简化成PUB/SUB的消息服务。



SOA架构演进：

![](https://tva1.sinaimg.cn/large/008i3skNly1gpz5ryz8sij30o10afwmf.jpg)

1. 软件模块高度耦合
2. 松耦合，需要标准的协议或者中间件来联动服务。服务间不需要直接依赖，而是通过中间件的标准或者通信框架相互依赖。IoC控制反转和DI依赖倒置。不是直接调用
3. 微服务架构，每个服务自包含。和传统的SOA差别在于，服务间的整合需要一个**服务编排**或者服务的整合引擎。

微服务也要辅助于容器化调度的方式，如kubernetes。在[microservice](https://martinfowler.com/articles/microservices.html)中有详细描述

微服务使得开发速度更快，隔离性好，系统扩展性好，但是在集成测试、运维和服务管理等方面就比较麻烦。所以就需要一套比较好的PaaS平台。



分布式必备的技术有哪些？RPC、MQ、集群存储系统，负载均衡、容器化部署



23 分布式系统技术栈

- 服务治理。服务治理最大的意义是把服务之间的依赖关系、服务调用链、以及关键服务梳理出来(Kiali面板)
- DevOps，分布式更快更新服务。其中包括环境构建、持续集成持续部署
- 自动化运维，DevOps之后，对服务进行伸缩，故障迁移，配置管理，状态管理
- 架构监控：
- 流量控制：



在Docker以及Kubernetes之上衍生出了一系列解决方案，docker把软件和环境打包，轻量级的启动和运行。docker容器化虚拟化是未来。



- 全栈系统监控
- 服务、资源调度
- 流量调度
- 状态、数据调度
- 开发和运维自动化

最后的开发运维自动化是需要前四个做到，才有可能实现。



24 全栈监控

在分布式或者Cloud Native情况下，系统分成多层，服务关联，需要有一个号的监控系统

- 基础层监控：cpu，内存，硬盘io
- 中间层：nginx，redis，kafka
- 应用层：http访问的吞吐量



第27讲  PaaS平台的本质

软件工程的能力：

1. 提高SLA，服务的可用性。

2. 能力和资源重用或复用：软件模块的重用、运行环境和资源的重用
3. 过程的自动化：软件生产流水线、软件运维自动化

分布式的技术点

- 分布式多层的系统架构
- 服务化的能力供应
- 自动化的运维能力

这样通过对PaaS能力的改造，就能发挥出云计算的优势，这就是所谓的Cloud Native。

分布式系统关键技术和软件工程的本质都能在PaaS平台上体现出来。

一个好的PaaS平台应该具有分布式、服务化、自动化部署、高可用、敏捷以及分层开放的特征。

- 服务化是PaaS的本质，即软件模块的重用    -   微服务、容器化
- 分布式是PaaS的根本特征，高可用、服务编排  -  kubernetes搭建分布式测量集群
- 自动化是PaaS的灵魂，自动化部署安装和运维  -  Operator实现自动化容器编排



PaaS平台作为云计算和分布式中重要的一环，

服务化，运用面向SOA的思想，对单体应用解耦，实现模块化重用。

分布式，多租户隔离，高可用，服务编排。

自动化，故障自动恢复，自动化部署安装运维、自动化伸缩调度。





如果没有docker和kubernetes，那么构建PaaS会复杂很多，



![](https://tva1.sinaimg.cn/large/008i3skNgy1gpx5zz9mbej30o10g6tfe.jpg)



在docker以及k8s层之上，有两个相关的PaaS层：PaaS调度层和PaaS服务能力层

本文更多在说PaaS调度层的东西

完整的PaaS平台主要包括：

- PaaS调度层  -  自动化和分布式对于高可用性能的管理
- PaaS能力服务层  - 提供应用支撑
- PaaS运营管理  - 软件接入
- PaaS运维管理 - DevOps



软件生产、运维和服务接入的流程。



![](https://tva1.sinaimg.cn/large/008i3skNgy1gpx690tj60j30o108x435.jpg)



第一部分：从软件资产库(Registry)中出发，进入DevOps流程(CI/CD)。通过整体架构控制器进入服务调度集群。

第二部分：同步服务运行状态，通过生命周期来拟合状态，应用监控中的一些监控事件同步到生命周期管理中，

左下是服务接入的组件，网关服务，以及API聚合编排和处理流程，对应于流量调度和API Gateway相关功能。



同步服务的运行状态，并通过生命周期来拟合状态，



81 程序员练级攻略 - 分布式架构入门

学好分布式系统及其架构，需要大量的时间和实践。

- 非常健壮的分布式系统不多，如果要用开源的，需要hold住源码
- 管理和协调多个服务或者机器是非常难的，意味着，需要去读很多的分布式系统论文
- 分布式环境下，出问题很难debug，需要一个监控和跟踪系统。
- 分布式环境下，需要应用服务化，需要微服务。
- 自动化运维平台





# 容器与容器云  浙江大学SEL实验室



基于docker技术构建出各种各样的容器云平台，docker等容器技术的重心从容器到了容器云，docker的价值也从节省资源扩展到对整个软件开发运维生命周期的改造。



第一部分，docker容器的核心原理，第三章分析源码，第四章介绍容器化思维以及docker相关的实践技巧，网络、监控、服务发现

第二部分，基于docker的容器云平台的架构细节和背后设计理念，kubernetes分析



正确使用docker，就需要建立起容器化思维，容器的本质是一个进程以及运行该进程所需要的各种依赖。









### 3.8 docker网络管理



### 第四章  高级网络实践

docker有四种网络驱动，

-  host，容器和主机使用一个网络栈，但是没有隔离，缺乏安全性
-  bridge，容器没有对外IP，通过NAT实现对外通信，不能解决跨主机容器间直接通信问题。
-  overlay驱动，支持跨主机的网络通信，配合swarm进行配置和使用。
-  null不进行任何网络设置



docker应用在大规模集群环境中，难以避免docker容器跨主机通信。

不同主机上的docker容器只能通过在主机上做端口映射来通信，

4.2.2演示使用虚拟网桥将docker容器桥接到本地网络环境中，把同一局域网中不同主机上的docker容器都配置在主机网路环境中，会产生以下问题：

- docker容器占用主机网络的IP地址，
- 大量容器会产生广播风暴
- docker容器连在主机网络中有安全问题。



4.5 容器化应用构建的基础：高可用配置中心

以微服务构建的应用中，服务发现，服务状态发布和订阅等模块发挥了连接微服务的重要作用。

高可用的配置中心就是实现这些功能的关键技术。









### 第五章 构建自己的容器云

大部分经典PaaS平台中容器功能被局限在“资源隔离”这个狭小的技术范围之中。但是当拥有了docker这样的容器技术之后，是时候开始从一个新的角度来思考容器在云计算平台当中扮演的角色和地位了。

IaaS平台接管资源的虚拟化工作，通过软件定义的方式为租户提供虚拟的计算、网络和存储资源。

PaaS平台接管所有运行时环境和应用支撑工作，云平台的租户因此可以申请配额内的计算单元来运行自己的服务



在两层的基础上，用户部署的应用和服务通过API响应的方式组成一系列集合服务于用户。这就是SaaS



